<link rel="import" href="./Middleware.html">
<script>
  class FetchMiddleware extends Middleware {
    constructor() {
      super();
    }

    getQueryString(params) {
      var esc = encodeURIComponent;
      return Object.keys(params)
        .map(k => esc(k) + '=' + esc(params[k]))
        .join('&');
    }

    transform_request(target, req) {
      req = req || {};
      var method = (req.method || 'get').toLowerCase();
      if (req.data && method && method === 'post') {
        try {
          req.body = JSON.stringify(req.data)
        } catch (err) {
          console.error(err)
        }

        var headers = req.headers
        if (!headers) {
          headers = {
            'content-type': 'application/json'
          };
        } else {
          Object.keys(headers).forEach(function (key) {
            if (key.toLowerCase() === 'content-type' && !headers[key]) {
              headers[key] = 'application/json'
            }
          });
        }


        delete req.data
        req.headers = headers
      } else if (method === 'get' && req.data) {
        var qs = '?' + this.getQueryString(req.data)
        target += qs;
        delete req.data
      }
      return [target, req];
    }

    fetch(target, req) {
      return this.next.fetch.apply(this, this.transform_request(target, req))
    }
  }

  window.customElements.define('middleware-fetch', FetchMiddleware);
</script>
